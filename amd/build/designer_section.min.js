/**
 * Implemented designer format js.
 *
 * @module     format_designer/designer_section
 * @copyright  2021 bdecent gmbh <https://bdecent.de>
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("format_designer/designer_section",["jquery","core/fragment","core/templates","core/loadingicon","core/ajax","core_course/actions","core_message/toggle_contact_button","theme_boost/popover","core/notification"],(function($,Fragment,Templates,Loadingicon,Ajax,Actions,Contact,Notification){var SELECTOR={ACTIVITYLI:"li.activity",SECTIONLI:"li.section",ACTIVITYACTION:"a.cm-edit-action",SECTIONACTIONMENU:".section_action_menu.designer-menu"};Y.use("moodle-course-coursebase",(function(){var courseformatselector=M.course.format.get_section_selector();courseformatselector&&(SELECTOR.SECTIONLI=courseformatselector)}));let DesignerSection=function(courseId,contextId,popupActivities,videoTime,issubpanel,sectionreturn){var self=this;self.courseId=courseId,self.contextId=contextId,self.popupActivities=popupActivities,self.videoTime=videoTime,self.isSubpanel=issubpanel,self.sectionReturn=sectionreturn,$(".course-info-block .carousel .carousel-item:nth-child(1)").addClass("active"),$(".course-info-block #courseStaffinfoControls.carousel").addClass("active"),$("body").delegate(self.SectionController,"click",self.sectionLayoutaction.bind(this)),$("body").delegate(self.SectionSubmenuSwitcher,"click",self.sectionLayoutaction.bind(this)),$("body").delegate(self.RestrictInfo,"click",self.moduleHandler.bind(this)),$("body").delegate(self.sectionRestricted,"click",this.sectionRestrictHandler.bind(this)),$("body").delegate(self.fullDescription,"click",self.fullmodcontentHandler.bind(this)),$("body").delegate(self.trimDescription,"click",self.trimmodcontentHandler.bind(this)),$("body").delegate(self.goToURL,"click",self.redirectToModule.bind(this)),$("body").delegate(self.goToSectionURL,"click",self.redirectToSection.bind(this)),window.onhashchange=function(){self.expandSection()},this.expandSection();var contactModalHandler=document.getElementsByClassName("toggle-contact-button");Array.from(contactModalHandler).forEach((function(element){element.addEventListener("click",(function(e){e.preventDefault(),null!=e.currentTarget.dataset.userid&&Contact.enhance(e.currentTarget)}))})),$('.progress .progress-bar[data-toggle="popover"]').popover()};return DesignerSection.prototype.goToURL='.designer [data-action="go-to-url"]',DesignerSection.prototype.goToSectionURL='.designer [data-action="go-to-section-url"]',DesignerSection.prototype.SectionController=".designer #section-designer-action .dropdown-menu a",DesignerSection.prototype.SectionSubmenuSwitcher=".designer .section_action_menu .dropdown-subpanel a[data-value=section-designer-action] + .dropdown-menu a",DesignerSection.prototype.RestrictInfo=".designer .designer-section-content .call-action-block",DesignerSection.prototype.moduleBlock=".designer .designer-section-content li.activity",DesignerSection.prototype.loadingElement=".icon-loader-block",DesignerSection.prototype.sectionRestricted=".designer .availability-section-block .section-restricted-action",DesignerSection.prototype.fullDescription=".designer-section-content li .fullcontent-summary .mod-description-action",DesignerSection.prototype.trimDescription=".designer-section-content li .trim-summary .mod-description-action",DesignerSection.prototype.modules=null,DesignerSection.prototype.redirectToModule=function(event){let nodeName=event.target.nodeName,iscircle=event.target.closest("li.activity").classList.contains("circle-layout"),isDescription=event.target.classList.contains("mod-description-action"),isPadlock=event.target.classList.contains("fa-lock"),ispopupModule=event.target.closest("li.activity").classList.contains("popmodule"),isModHasURL=event.target.closest('li.activity div[data-action="go-to-url"]').getAttribute("data-url"),isCompletionButton=event.target.closest('button[data-action="toggle-manual-completion"]');if(nodeName in["a","button","form"]||document.body.classList.contains("editing")||iscircle||isDescription||isPadlock||ispopupModule||""==isModHasURL||isCompletionButton){if(ispopupModule&&!document.body.classList.contains("editing"))if(null===event.target.closest("button[data-action='toggle-manual-completion']")&&null===event.target.closest(".mod-description-action"))event.target.closest("li.activity").querySelector("a[href]").click();return null}let modurl=event.target.closest("[data-action=go-to-url]").getAttribute("data-url");return window.location.href=modurl,!0},DesignerSection.prototype.redirectToSection=function(event){let isPadlock=event.target.classList.contains("fa-lock");if(document.body.classList.contains("editing")||isPadlock)return null;var singlesection=event.target.closest("[data-action=go-to-section-url]");let sectionurl=singlesection.getAttribute("data-url"),sectiontarget="_self",target=singlesection.getAttribute("data-target");return target&&(sectiontarget=target),window.open(sectionurl,sectiontarget),!0},DesignerSection.prototype.expandSection=()=>{var sectionID=window.location.hash;if(sectionID){var id=sectionID.substring(1),section=document.getElementById(id);if(section){var title=section.querySelector(".section-header-content");title&&(title.classList.remove("collapsed"),title.setAttribute("aria-expanded",!0));var content=section.querySelector(".content");content&&content.classList.add("show"),null!==document.getElementById("section-course-accordion")&&(document.getElementById("section-head-0").classList.add("collapsed"),document.getElementById("section-content-0").classList.remove("show")),section.scrollIntoView()}}},DesignerSection.prototype.fullmodcontentHandler=function(event){var THIS=$(event.currentTarget);let fullContent=$(THIS).closest("li.activity").find(".fullcontent-summary"),trimcontent=$(THIS).closest("li.activity").find(".trim-summary");trimcontent.hasClass("summary-hide")&&(trimcontent.removeClass("summary-hide"),fullContent.addClass("summary-hide"))},DesignerSection.prototype.trimmodcontentHandler=function(event){var THIS=$(event.currentTarget);let fullContent=$(THIS).closest("li.activity").find(".fullcontent-summary"),trimcontent=$(THIS).closest("li.activity").find(".trim-summary");fullContent.hasClass("summary-hide")&&(fullContent.removeClass("summary-hide"),trimcontent.addClass("summary-hide"))},DesignerSection.prototype.sectionRestrictHandler=function(event){var sectionRestrictInfo=$(event.currentTarget).prev();sectionRestrictInfo&&(sectionRestrictInfo.hasClass("show")?sectionRestrictInfo.removeClass("show"):sectionRestrictInfo.addClass("show"))},DesignerSection.prototype.moduleHandler=function(event){event.preventDefault();var restrictBlock=$(event.currentTarget).parents(".restrict-block");restrictBlock.length&&(restrictBlock.hasClass("show")?restrictBlock.removeClass("show"):restrictBlock.addClass("show"))},DesignerSection.prototype.updateVideoTimeInstance=function(sectionId){var sectionVideotimes="body "+("#"+sectionId)+" .activity.videotime";0!=$(sectionVideotimes).length&&$(sectionVideotimes).each(function(index,module){this.CreateInstance(module)}.bind(this))},DesignerSection.prototype.CreateInstance=function(module){if($(module).find(".instancename").length&&($(module).find(".vimeo-embed").length||$(module).find(".video-js").length)){var args={cmid:module.getAttribute("data-id")};Ajax.call([{methodname:"format_designer_get_videotime_instace",args:args}],!0)[0].then((function(data){var template=JSON.parse(data);if("videojs"==template.playertype)var uniqueid=$(module).find(".video-js").first().attr("id").replace("vimeo-embed-","");else uniqueid=$(module).find(".vimeo-embed").first().attr("id").replace("vimeo-embed-","");template.uniqueid=uniqueid,Templates.render(template.templatename,template).then((function(html,js){return Templates.runTemplateJS(js),!0})).fail(Notification.exception)}))}},DesignerSection.prototype.sectionLayoutaction=function(event){event.preventDefault();var self=this;let sectionId=event.target.closest("li.section").getAttribute("id");var sectionid=event.target.closest("li.section").getAttribute("data-id"),sectionitem=document.getElementById(sectionId),iconBlock="#"+sectionId+" "+self.loadingElement,layout=$(event.currentTarget).data("value"),layouttext=$(event.currentTarget).text();$(event.target).parents(".dropdown").find(".btn").html(layouttext),$(event.target).parents(".dropdown").find(".btn").val(layout),$(event.target).parent().find("a.dropdown-item").each((function(){$(this).removeClass("active")})),$(event.target).addClass("active");let dataid=event.target.closest("li.section").getAttribute("data-id");var args={courseid:self.courseId,sectionid:dataid,options:[{name:$(event.currentTarget).data("option"),value:layout}]},promises=Ajax.call([{methodname:"format_designer_set_section_options",args:args}],!0);$.when.apply($,promises).done((function(){if(self.isSubpanel){Fragment.loadFragment("core_courseformat","section",self.contextId,{id:sectionid,courseid:self.courseId,sr:self.sectionReturn}).then(((html,js)=>{Templates.replaceNode(sectionitem,html,js)})).catch()}else{Actions.refreshSection("#"+sectionId,dataid,0).then((()=>"")).catch()}})),Loadingicon.addIconToContainerRemoveOnCompletion(iconBlock,promises),setTimeout((function(){self.videoTime&&self.updateVideoTimeInstance(sectionId)}),2e3)},{init:function(courseId,contextId,popupActivities,videoTime,issubpanel,sectionreturn){return new DesignerSection(courseId,contextId,popupActivities,videoTime,issubpanel,sectionreturn)}}}));

//# sourceMappingURL=designer_section.min.js.map
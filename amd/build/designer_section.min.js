define ("format_designer/designer_section",["jquery","core/fragment","core/templates","core/loadingicon","core/ajax","core_message/toggle_contact_button"],function(a,b,c,d,e,f){var g={ACTIVITYLI:"li.activity",SECTIONLI:"li.section",ACTIVITYACTION:"a.cm-edit-action",SECTIONACTIONMENU:".section_action_menu.designer-menu"};Y.use("moodle-course-coursebase",function(){var a=M.course.format.get_section_selector();if(a){g.SECTIONLI=a}});var h=function(b,c,d){var e=this;e.courseId=b;e.contextId=c;e.popupActivities=d;a(".course-info-block .carousel .carousel-item:nth-child(1)").addClass("active");a(".course-info-block #courseStaffinfoControls.carousel").addClass("active");a("body").delegate(e.SectionController,"click",e.sectionLayoutaction.bind(this));a("body").delegate(e.RestrictInfo,"click",e.moduleHandler.bind(this));a("body").delegate(e.sectionRestricted,"click",this.sectionRestrictHandler.bind(this));a("body").delegate(e.fullDescription,"click",e.fullmodcontentHandler.bind(this));a("body").delegate(e.trimDescription,"click",e.trimmodcontentHandler.bind(this));a("body").on("click keypress",g.ACTIVITYLI+" "+g.ACTIVITYACTION+"[data-action]",this.editModuleRenderer.bind(this));a("body").delegate(e.goToURL,"click",e.redirectToModule.bind(this));window.onhashchange=function(){e.expandSection()};this.expandSection();if(0<a(".course-type-flow").length){a(".collapse").on("show.bs.collapse",function(){a(this).parents("li.section").addClass("stack-header-collapsing");var b=a(this).parents("li.section").attr("id"),c=document.getElementById(b),d=c.offsetTop-document.body.scrollTop;setTimeout(function(){return window.scroll(0,d)},50)}).on("shown.bs.collapse",function(){a(this).parents("li.section").removeClass("stack-header-collapsing")})}var h=document.getElementsByClassName("toggle-contact-button");Array.from(h).forEach(function(a){a.addEventListener("click",function(a){a.preventDefault();if(a.currentTarget.dataset.userid!=void 0){console.log(a.currentTarget.dataset.userid);f.enhance(a.currentTarget)}})})};h.prototype.goToURL=".designer [data-action=\"go-to-url\"]";h.prototype.SectionController=".designer #section-designer-action .dropdown-menu a";h.prototype.RestrictInfo=".designer .designer-section-content .call-action-block";h.prototype.moduleBlock=".designer .designer-section-content li.activity";h.prototype.loadingElement=".icon-loader-block";h.prototype.sectionRestricted=".designer .availability-section-block .section-restricted-action";h.prototype.moduleDescription=".designer .designer-section-content li .mod-description-action";h.prototype.fullDescription=".designer-section-content li .fullcontent-summary .mod-description-action";h.prototype.trimDescription=".designer-section-content li .trim-summary .mod-description-action";h.prototype.modules=null;h.prototype.addSectionSpinner=function(b){var c=a(b).addClass("editinprogress"),d=c.find("li.section").get(0);if(d){var e=M.util.add_spinner(Y,Y.Node(d));e.show();return e}return null};h.prototype.redirectToModule=function(a){var b=a.target.nodeName,c=a.target.closest("li.activity").classList.contains("circle-layout"),d=a.target.classList.contains("mod-description-action"),e=a.target.classList.contains("fa-lock"),f=a.target.closest("li.activity").classList.contains("popmodule");if(b in["a","button","form"]||document.body.classList.contains("editing")||c||d||e||f){if(f&&!document.body.classList.contains("editing")){var g=a.target.closest("li.activity");g.querySelector("a[href]").click()}return null}var h=a.target.closest("[data-action=go-to-url]"),i=h.getAttribute("data-url");window.location.href=i;return!0};h.prototype.expandSection=function(){var a=window.location.hash;if(a){var b=a.substring(1),c=document.getElementById(b);if(c){var d=c.querySelector(".section-header-content");if(d){d.classList.remove("collapsed");d.setAttribute("aria-expanded",!0)}var e=c.querySelector(".content");if(e){e.classList.add("show")}if(null!==document.getElementById("section-course-accordion")){document.getElementById("section-head-0").classList.add("collapsed");document.getElementById("section-content-0").classList.remove("show")}c.scrollIntoView()}}};h.prototype.removeSectionSpinner=function(b,c,d){var e=a(b);window.setTimeout(function(){e.removeClass("editinprogress");if(c){c.hide()}},d)};h.prototype.getModuleId=function(a){var b;Y.use("moodle-course-util",function(c){b=c.Moodle.core_course.util.cm.getId(c.Node(a.get(0)))});return b};h.prototype.refreshSectionInfo=function(b){var c=this,d=b.currentTarget.closest("li.section"),f=a(d).attr("data-id"),g=a(d).attr("data-sectionreturnid"),h=c.addSectionSpinner(d),i={courseid:c.courseId,sectionid:f,sectionreturn:g};window.setTimeout(function(b){var d=e.call([{methodname:"format_designer_section_refresh",args:b}],!0);a.when.apply(a,d).done(function(b){var d=a.parseJSON(b);if(d.modules!==void 0){for(var e in d.modules){c.replaceActivityhtml(d.modules[e])}}})},1e3,i);c.removeSectionSpinner(d,h,400)};h.prototype.editModuleRenderer=function(b){var c=this;if("keypress"===b.type&&13!==b.keyCode){return}var d=a(b.currentTarget),e=d.closest(g.ACTIVITYLI),f=d.attr("data-action"),h=c.getModuleId(e);switch(f){case"moveleft":case"moveright":case"delete":case"duplicate":case"hide":case"stealth":case"show":case"groupsseparate":case"groupsvisible":case"groupsnone":break;default:return;}if(!h){return}b.preventDefault();if("delete"===f){window.setTimeout(function(){a(".modal-footer button[data-action=\"save\"]").click(function(){c.refreshSectionInfo(b)})},500)}else{c.refreshSectionInfo(b)}};h.prototype.fullmodcontentHandler=function(b){var c=a(b.currentTarget),d=a(c).closest("li.activity").find(".fullcontent-summary"),e=a(c).closest("li.activity").find(".trim-summary");if(e.hasClass("summary-hide")){e.removeClass("summary-hide");d.addClass("summary-hide")}};h.prototype.trimmodcontentHandler=function(b){var c=a(b.currentTarget),d=a(c).closest("li.activity").find(".fullcontent-summary"),e=a(c).closest("li.activity").find(".trim-summary");if(d.hasClass("summary-hide")){d.removeClass("summary-hide");e.addClass("summary-hide")}};h.prototype.sectionRestrictHandler=function(b){var c=a(b.currentTarget).prev();if(c){if(!c.hasClass("show")){c.addClass("show")}else{c.removeClass("show")}}};h.prototype.moduleHandler=function(b){b.preventDefault();var c=a(b.currentTarget).parents(".restrict-block");if(c.length){if(!c.hasClass("show")){c.addClass("show")}else{c.removeClass("show")}}};h.prototype.sectionLayoutaction=function(b){var c=this,f=b.target.closest("li.section").getAttribute("id"),g="#"+f+" "+c.loadingElement,h=a(b.currentTarget).data("value"),i=a(b.currentTarget).text();a(b.target).parents(".dropdown").find(".btn").html(i);a(b.target).parents(".dropdown").find(".btn").val(h);a(b.target).parent().find("a.dropdown-item").each(function(){a(this).removeClass("active")});a(b.target).addClass("active");var j=b.target.closest("li.section").getAttribute("data-id"),k={courseid:c.courseId,sectionid:j,options:[{name:a(b.currentTarget).data("option"),value:h}]},l={cards:"card-deck card-layout",list:"list-layout",default:"link-layout",circles:"circles-layout",horizontal_circles:"circles-layout horizontal-circles-layout"},m=e.call([{methodname:"format_designer_set_section_options",args:k}],!0);a.when.apply(a,m).done(function(b){var d=a.parseJSON(b);if(d.modules!==void 0){for(var e in d.modules){c.replaceActivityhtml(d.modules[e])}document.getElementById(f).classList.forEach(function(a){if(a.startsWith("section-type-")){document.getElementById(f).classList.remove(a)}});document.getElementById(f).classList.add("section-type-"+h);a("#"+f).find("ul.section").removeClass(l.cards);a("#"+f).find("ul.section").removeClass(l.list);a("#"+f).find("ul.section").removeClass(l.default);a("#"+f).find("ul.section").removeClass(l.circles);a("#"+f).find("ul.section").addClass(l[h])}});d.addIconToContainerRemoveOnCompletion(g,m)};h.prototype.replaceActivityhtml=function(b){a("<div>"+b+"</div>").find(g.ACTIVITYLI).each(function(){var c=a(this).attr("id");a(g.ACTIVITYLI+"#"+c).replaceWith(b);i(c)})};var i=function(a){Y.use("moodle-course-coursebase",function(){M.course.coursebase.invoke_function("setup_for_resource","#"+a)});if(M.core.actionmenu&&M.core.actionmenu.newDOMNode){M.core.actionmenu.newDOMNode(Y.one("#"+a))}};return{init:function init(a,b,c){return new h(a,b,c)}}});
//# sourceMappingURL=designer_section.min.js.map

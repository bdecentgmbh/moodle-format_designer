/**
 * Implemented designer format js.
 *
 * @module     format_designer/designer_section
 * @copyright  2021 bdecent gmbh <https://bdecent.de>
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("format_designer/designer_section",["jquery","core/loadingicon","core/ajax","core_message/toggle_contact_button"],(function($,Loadingicon,Ajax,Contact){var SELECTOR={ACTIVITYLI:"li.activity",SECTIONLI:"li.section",ACTIVITYACTION:"a.cm-edit-action",SECTIONACTIONMENU:".section_action_menu.designer-menu"};Y.use("moodle-course-coursebase",(function(){var courseformatselector=M.course.format.get_section_selector();courseformatselector&&(SELECTOR.SECTIONLI=courseformatselector)}));var DesignerSection=function(courseId,contextId,popupActivities){var self=this;self.courseId=courseId,self.contextId=contextId,self.popupActivities=popupActivities,$(".course-info-block .carousel .carousel-item:nth-child(1)").addClass("active"),$(".course-info-block #courseStaffinfoControls.carousel").addClass("active"),$("body").delegate(self.SectionController,"click",self.sectionLayoutaction.bind(this)),$("body").delegate(self.RestrictInfo,"click",self.moduleHandler.bind(this)),$("body").delegate(self.sectionRestricted,"click",this.sectionRestrictHandler.bind(this)),$("body").delegate(self.fullDescription,"click",self.fullmodcontentHandler.bind(this)),$("body").delegate(self.trimDescription,"click",self.trimmodcontentHandler.bind(this)),$("body").on("click keypress",SELECTOR.ACTIVITYLI+" "+SELECTOR.ACTIVITYACTION+"[data-action]",this.editModuleRenderer.bind(this)),$("body").delegate(self.goToURL,"click",self.redirectToModule.bind(this)),window.onhashchange=function(){self.expandSection()},this.expandSection(),$(".course-type-flow").length>0&&$(".collapse").on("show.bs.collapse",(function(){$(this).parents("li.section").addClass("stack-header-collapsing");var sectionid=$(this).parents("li.section").attr("id"),distance=document.getElementById(sectionid).offsetTop-document.body.scrollTop;setTimeout((function(){return window.scroll(0,distance)}),50)})).on("shown.bs.collapse",(function(){$(this).parents("li.section").removeClass("stack-header-collapsing")}));var contactModal=document.getElementsByClassName("toggle-contact-button");Array.from(contactModal).forEach((function(element){element.addEventListener("click",(function(e){e.preventDefault(),null!=e.currentTarget.dataset.userid&&Contact.enhance(e.currentTarget)}))})),$('.progress .progress-bar[data-toggle="popover"]').popover()};DesignerSection.prototype.goToURL='.designer [data-action="go-to-url"]',DesignerSection.prototype.SectionController=".designer #section-designer-action .dropdown-menu a",DesignerSection.prototype.RestrictInfo=".designer .designer-section-content .call-action-block",DesignerSection.prototype.moduleBlock=".designer .designer-section-content li.activity",DesignerSection.prototype.loadingElement=".icon-loader-block",DesignerSection.prototype.sectionRestricted=".designer .availability-section-block .section-restricted-action",DesignerSection.prototype.moduleDescription=".designer .designer-section-content li .mod-description-action",DesignerSection.prototype.fullDescription=".designer-section-content li .fullcontent-summary .mod-description-action",DesignerSection.prototype.trimDescription=".designer-section-content li .trim-summary .mod-description-action",DesignerSection.prototype.modules=null,DesignerSection.prototype.addSectionSpinner=function(sectioninfo){var actionarea=$(sectioninfo).addClass("editinprogress").find("li.section").get(0);if(actionarea){var spinner=M.util.add_spinner(Y,Y.Node(actionarea));return spinner.show(),spinner}return null},DesignerSection.prototype.redirectToModule=function(event){var nodeName=event.target.nodeName,iscircle=event.target.closest("li.activity").classList.contains("circle-layout"),isDescription=event.target.classList.contains("mod-description-action"),isPadlock=event.target.classList.contains("fa-lock"),ispopupModule=event.target.closest("li.activity").classList.contains("popmodule");if(nodeName in["a","button","form"]||document.body.classList.contains("editing")||iscircle||isDescription||isPadlock||ispopupModule){if(ispopupModule&&!document.body.classList.contains("editing"))event.target.closest("li.activity").querySelector("a[href]").click();return null}var modurl=event.target.closest("[data-action=go-to-url]").getAttribute("data-url");return window.location.href=modurl,!0},DesignerSection.prototype.expandSection=function(){var sectionID=window.location.hash;if(sectionID){var id=sectionID.substring(1),section=document.getElementById(id);if(section){var title=section.querySelector(".section-header-content");title&&(title.classList.remove("collapsed"),title.setAttribute("aria-expanded",!0));var content=section.querySelector(".content");content&&content.classList.add("show"),null!==document.getElementById("section-course-accordion")&&(document.getElementById("section-head-0").classList.add("collapsed"),document.getElementById("section-content-0").classList.remove("show")),section.scrollIntoView()}}},DesignerSection.prototype.removeSectionSpinner=function(sectioninfo,spinner,delay){var element=$(sectioninfo);window.setTimeout((function(){element.removeClass("editinprogress"),spinner&&spinner.hide()}),delay)},DesignerSection.prototype.getModuleId=function(element){var id;return Y.use("moodle-course-util",(function(Y){id=Y.Moodle.core_course.util.cm.getId(Y.Node(element.get(0)))})),id},DesignerSection.prototype.refreshSectionInfo=function(target){var self=this,sectioninfo=target.currentTarget.closest("li.section"),sectionId=$(sectioninfo).attr("data-id"),sectionReturn=$(sectioninfo).attr("data-sectionreturnid"),spinner=self.addSectionSpinner(sectioninfo),args={courseid:self.courseId,sectionid:sectionId,sectionreturn:sectionReturn};window.setTimeout((function(args){var promises=Ajax.call([{methodname:"format_designer_section_refresh",args:args}],!0);$.when.apply($,promises).done((function(dataencoded){var data=$.parseJSON(dataencoded);if(void 0!==data.modules)for(var i in data.modules)self.replaceActivityhtml(data.modules[i])}))}),1e3,args),self.removeSectionSpinner(sectioninfo,spinner,400)},DesignerSection.prototype.editModuleRenderer=function(event){var self=this;if("keypress"!==event.type||13===event.keyCode){var actionItem=$(event.currentTarget),moduleElement=actionItem.closest(SELECTOR.ACTIVITYLI),action=actionItem.attr("data-action"),moduleId=self.getModuleId(moduleElement);switch(action){case"moveleft":case"moveright":case"delete":case"duplicate":case"hide":case"stealth":case"show":case"groupsseparate":case"groupsvisible":case"groupsnone":break;default:return}moduleId&&(event.preventDefault(),"delete"===action?window.setTimeout((function(){$('.modal-footer button[data-action="save"]').click((function(){self.refreshSectionInfo(event)}))}),500):self.refreshSectionInfo(event))}},DesignerSection.prototype.fullmodcontentHandler=function(event){var THIS=$(event.currentTarget),fullContent=$(THIS).closest("li.activity").find(".fullcontent-summary"),trimcontent=$(THIS).closest("li.activity").find(".trim-summary");trimcontent.hasClass("summary-hide")&&(trimcontent.removeClass("summary-hide"),fullContent.addClass("summary-hide"))},DesignerSection.prototype.trimmodcontentHandler=function(event){var THIS=$(event.currentTarget),fullContent=$(THIS).closest("li.activity").find(".fullcontent-summary"),trimcontent=$(THIS).closest("li.activity").find(".trim-summary");fullContent.hasClass("summary-hide")&&(fullContent.removeClass("summary-hide"),trimcontent.addClass("summary-hide"))},DesignerSection.prototype.sectionRestrictHandler=function(event){var sectionRestrictInfo=$(event.currentTarget).prev();sectionRestrictInfo&&(sectionRestrictInfo.hasClass("show")?sectionRestrictInfo.removeClass("show"):sectionRestrictInfo.addClass("show"))},DesignerSection.prototype.moduleHandler=function(event){event.preventDefault();var restrictBlock=$(event.currentTarget).parents(".restrict-block");restrictBlock.length&&(restrictBlock.hasClass("show")?restrictBlock.removeClass("show"):restrictBlock.addClass("show"))},DesignerSection.prototype.sectionLayoutaction=function(event){var self=this,sectionId=event.target.closest("li.section").getAttribute("id"),iconBlock="#"+sectionId+" "+self.loadingElement,layout=$(event.currentTarget).data("value"),layouttext=$(event.currentTarget).text();$(event.target).parents(".dropdown").find(".btn").html(layouttext),$(event.target).parents(".dropdown").find(".btn").val(layout),$(event.target).parent().find("a.dropdown-item").each((function(){$(this).removeClass("active")})),$(event.target).addClass("active");var dataid=event.target.closest("li.section").getAttribute("data-id"),args={courseid:self.courseId,sectionid:dataid,options:[{name:$(event.currentTarget).data("option"),value:layout}]},ULClasses={cards:"card-deck card-layout",list:"list-layout",default:"link-layout",circles:"circles-layout",horizontal_circles:"circles-layout horizontal-circles-layout"},promises=Ajax.call([{methodname:"format_designer_set_section_options",args:args}],!0);$.when.apply($,promises).done((function(dataencoded){var data=$.parseJSON(dataencoded);if(void 0!==data.modules){for(var i in data.modules)self.replaceActivityhtml(data.modules[i]);document.getElementById(sectionId).classList.forEach((function(className){className.startsWith("section-type-")&&document.getElementById(sectionId).classList.remove(className)})),document.getElementById(sectionId).classList.add("section-type-"+layout),$("#"+sectionId).find("ul.section").removeClass(ULClasses.cards),$("#"+sectionId).find("ul.section").removeClass(ULClasses.list),$("#"+sectionId).find("ul.section").removeClass(ULClasses.default),$("#"+sectionId).find("ul.section").removeClass(ULClasses.circles),$("#"+sectionId).find("ul.section").removeClass(ULClasses.horizontal_circles),$("#"+sectionId).find("ul.section").addClass(ULClasses[layout])}})),Loadingicon.addIconToContainerRemoveOnCompletion(iconBlock,promises)},DesignerSection.prototype.replaceActivityhtml=function(activityHTML){$("<div>"+activityHTML+"</div>").find(SELECTOR.ACTIVITYLI).each((function(){var id=$(this).attr("id");$(SELECTOR.ACTIVITYLI+"#"+id).replaceWith(activityHTML),initActionMenu(id)}))};var initActionMenu=function(elementid){Y.use("moodle-course-coursebase",(function(){M.course.coursebase.invoke_function("setup_for_resource","#"+elementid)})),M.core.actionmenu&&M.core.actionmenu.newDOMNode&&M.core.actionmenu.newDOMNode(Y.one("#"+elementid))};return{init:function(courseId,contextId,popupActivities){return new DesignerSection(courseId,contextId,popupActivities)}}}));

//# sourceMappingURL=designer_section.min.js.map
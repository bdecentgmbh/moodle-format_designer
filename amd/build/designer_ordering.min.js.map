{"version":3,"sources":["../src/designer_ordering.js"],"names":["define","$","action","ajax","CSS","EDITINPROGRESS","EDITINGMOVE","SELECTOR","ACTIVITYLI","ACTIONAREA","SECTIONLI","initialize","Y","use","M","course","coursebase","register_module","set_visibility_resource_ui","args","mainelement","element","getDOMNode","cmid","getModuleId","css","sectionreturn","find","attr","sectionId","closest","spinner","addActivitySpinner","promises","call","methodname","id","sectionid","when","apply","done","data","removeSpinner","replaceActivityHtmlWith","fail","activityHTML","setTimeout","each","replaceWith","initActionMenu","Moodle","core_course","util","cm","getId","Node","get","delay","window","removeClass","hide","elementid","invoke_function","core","actionmenu","newDOMNode","one","activity","addClass","actionarea","add_spinner","show","init"],"mappings":"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","sourcesContent":["define(['jquery', 'format_designer/actions', 'core/ajax'], function($, action, ajax) {\r\n\r\n    var CSS = {\r\n        EDITINPROGRESS: 'editinprogress',\r\n        EDITINGMOVE: 'editing_move'\r\n    };\r\n\r\n    var SELECTOR = {\r\n        ACTIVITYLI: 'li.activity',\r\n        ACTIONAREA: '.actions',\r\n        SECTIONLI: 'li.section',\r\n    };\r\n    /**\r\n     * Implement the init.\r\n     */\r\n    function initialize() {\r\n\r\n        // Register a function to be executed after D&D of an activity.\r\n        Y.use('moodle-course-coursebase', function() {\r\n\r\n                M.course.coursebase.register_module({\r\n                    // Ignore camelcase eslint rule for the next line because it is an expected name of the callback.\r\n                    // eslint-disable-next-line camelcase\r\n                    set_visibility_resource_ui: function(args) {\r\n                        var mainelement = $(args.element.getDOMNode());\r\n                        var cmid = getModuleId(mainelement);\r\n                        if (cmid) {\r\n                            mainelement.css('opacity', 0);\r\n                            var sectionreturn = mainelement.find('.' + CSS.EDITINGMOVE).attr('data-sectionreturn');\r\n                            var sectionId = mainelement.closest(SELECTOR.SECTIONLI).attr('data-id');\r\n                            var spinner = addActivitySpinner(mainelement);\r\n                            var promises = ajax.call([{\r\n                                methodname: 'format_designer_get_module',\r\n                                args: {id: cmid, sectionid: sectionId, sectionreturn: sectionreturn}\r\n                            }], true);\r\n                            $.when.apply($, promises)\r\n                                .done(function(data) {\r\n                                removeSpinner(mainelement, spinner, 400);\r\n                                    replaceActivityHtmlWith(data);\r\n                                }).fail(function() {\r\n                                    removeSpinner(mainelement, spinner);\r\n                                });\r\n                        }\r\n                    }\r\n\r\n            });\r\n\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Replaces the course module with the new html (used to update module after it was edited or its visibility was changed).\r\n     *\r\n     * @param {String} activityHTML\r\n     */\r\n    function replaceActivityHtmlWith(activityHTML) {\r\n        setTimeout(function() {\r\n            $('<div>' + activityHTML + '</div>').find(SELECTOR.ACTIVITYLI).each(function() {\r\n                // Extract id from the new activity html.\r\n                var id = $(this).attr('id');\r\n                // Find the existing element with the same id and replace its contents with new html.\r\n                $(SELECTOR.ACTIVITYLI + '#' + id).replaceWith(activityHTML);\r\n                // Initialise action menu.\r\n                initActionMenu(id);\r\n                $(SELECTOR.ACTIVITYLI + '#' + id).css('opacity', 1);\r\n            });\r\n        }, 1000);\r\n    }\r\n\r\n    /**\r\n     * Wrapper for Y.Moodle.core_course.util.cm.getId\r\n     *\r\n     * @param {JQuery} element\r\n     * @returns {Integer}\r\n     */\r\n    function getModuleId(element) {\r\n        var id;\r\n        Y.use('moodle-course-util', function(Y) {\r\n            id = Y.Moodle.core_course.util.cm.getId(Y.Node(element.get(0)));\r\n        });\r\n        return id;\r\n    }\r\n\r\n    /**\r\n     * Removes the spinner element\r\n     *\r\n     * @param {JQuery} element\r\n     * @param {Node} spinner\r\n     * @param {Number} delay\r\n     */\r\n    function removeSpinner(element, spinner, delay) {\r\n        window.setTimeout(function() {\r\n            element.removeClass(CSS.EDITINPROGRESS);\r\n            if (spinner) {\r\n                spinner.hide();\r\n            }\r\n        }, delay);\r\n    }\r\n\r\n    /**\r\n     * Initialise action menu for the element (section or module)\r\n     *\r\n     * @param {String} elementid CSS id attribute of the element\r\n     */\r\n    function initActionMenu(elementid) {\r\n        // Initialise action menu in the new activity.\r\n        Y.use('moodle-course-coursebase', function() {\r\n            M.course.coursebase.invoke_function('setup_for_resource', '#' + elementid);\r\n        });\r\n        if (M.core.actionmenu && M.core.actionmenu.newDOMNode) {\r\n            M.core.actionmenu.newDOMNode(Y.one('#' + elementid));\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Wrapper for M.util.add_spinner for an activity\r\n     *\r\n     * @param {JQuery} activity\r\n     * @returns {Node}\r\n     */\r\n    function addActivitySpinner(activity) {\r\n        activity.addClass(CSS.EDITINPROGRESS);\r\n        var actionarea = activity.find(SELECTOR.ACTIONAREA).get(0);\r\n        if (actionarea) {\r\n            var spinner = M.util.add_spinner(Y, Y.Node(actionarea));\r\n            spinner.show();\r\n            return spinner;\r\n        }\r\n        return null;\r\n    }\r\n\r\n    return {\r\n        init: function() {\r\n            initialize();\r\n        }\r\n    };\r\n});"],"file":"designer_ordering.min.js"}
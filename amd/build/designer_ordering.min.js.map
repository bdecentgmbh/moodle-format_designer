{"version":3,"file":"designer_ordering.min.js","sources":["../src/designer_ordering.js"],"sourcesContent":["define(['jquery', 'core_course/actions', 'core/ajax'], function($, action, ajax) {\n\n    var CSS = {\n        EDITINPROGRESS: 'editinprogress',\n        EDITINGMOVE: 'editing_move'\n    };\n\n    var SELECTOR = {\n        ACTIVITYLI: 'li.activity',\n        ACTIONAREA: '.actions',\n        SECTIONLI: 'li.section',\n    };\n    /**\n     * Implement the init.\n     */\n    function init() {\n\n        // Register a function to be executed after D&D of an activity.\n        Y.use('moodle-course-coursebase', function() {\n\n                M.course.coursebase.register_module({\n                    // Ignore camelcase eslint rule for the next line because it is an expected name of the callback.\n                    // eslint-disable-next-line camelcase\n                    set_visibility_resource_ui: function(args) {\n                        var mainelement = $(args.element.getDOMNode());\n                        var cmid = getModuleId(mainelement);\n                        if (cmid) {\n                            mainelement.css('opacity', 0);\n                            var sectionreturn = mainelement.find('.' + CSS.EDITINGMOVE).attr('data-sectionreturn');\n                            var sectionId = mainelement.closest(SELECTOR.SECTIONLI).attr('data-id');\n                            var spinner = addActivitySpinner(mainelement);\n                            var promises = ajax.call([{\n                                methodname: 'format_designer_get_module',\n                                args: {id: cmid, sectionid: sectionId, sectionreturn: sectionreturn}\n                            }], true);\n                            $.when.apply($, promises)\n                                .done(function(data) {\n                                removeSpinner(mainelement, spinner, 400);\n                                    replaceActivityHtmlWith(data);\n                                }).fail(function() {\n                                    removeSpinner(mainelement, spinner);\n                                });\n                        }\n                    }\n\n            });\n\n        });\n    }\n\n    /**\n     * Replaces the course module with the new html (used to update module after it was edited or its visibility was changed).\n     *\n     * @param {String} activityHTML\n     */\n    function replaceActivityHtmlWith(activityHTML) {\n        setTimeout(function() {\n            $('<div>' + activityHTML + '</div>').find(SELECTOR.ACTIVITYLI).each(function() {\n                // Extract id from the new activity html.\n                var id = $(this).attr('id');\n                // Find the existing element with the same id and replace its contents with new html.\n                $(SELECTOR.ACTIVITYLI + '#' + id).replaceWith(activityHTML);\n                // Initialise action menu.\n                initActionMenu(id);\n                $(SELECTOR.ACTIVITYLI + '#' + id).css('opacity', 1);\n            });\n        }, 1000);\n    }\n\n    /**\n     * Wrapper for Y.Moodle.core_course.util.cm.getId\n     *\n     * @param {JQuery} element\n     * @returns {Integer}\n     */\n    function getModuleId(element) {\n        var id;\n        Y.use('moodle-course-util', function(Y) {\n            id = Y.Moodle.core_course.util.cm.getId(Y.Node(element.get(0)));\n        });\n        return id;\n    }\n\n    /**\n     * Removes the spinner element\n     *\n     * @param {JQuery} element\n     * @param {Node} spinner\n     * @param {Number} delay\n     */\n    function removeSpinner(element, spinner, delay) {\n        window.setTimeout(function() {\n            element.removeClass(CSS.EDITINPROGRESS);\n            if (spinner) {\n                spinner.hide();\n            }\n        }, delay);\n    }\n\n    /**\n     * Initialise action menu for the element (section or module)\n     *\n     * @param {String} elementid CSS id attribute of the element\n     */\n    function initActionMenu(elementid) {\n        // Initialise action menu in the new activity.\n        Y.use('moodle-course-coursebase', function() {\n            M.course.coursebase.invoke_function('setup_for_resource', '#' + elementid);\n        });\n        if (M.core.actionmenu && M.core.actionmenu.newDOMNode) {\n            M.core.actionmenu.newDOMNode(Y.one('#' + elementid));\n        }\n    }\n\n    /**\n     * Wrapper for M.util.add_spinner for an activity\n     *\n     * @param {JQuery} activity\n     * @returns {Node}\n     */\n    function addActivitySpinner(activity) {\n        activity.addClass(CSS.EDITINPROGRESS);\n        var actionarea = activity.find(SELECTOR.ACTIONAREA).get(0);\n        if (actionarea) {\n            var spinner = M.util.add_spinner(Y, Y.Node(actionarea));\n            spinner.show();\n            return spinner;\n        }\n        return null;\n    }\n\n    return {\n        init: init\n    };\n});"],"names":["define","$","action","ajax","CSS","SELECTOR","removeSpinner","element","spinner","delay","window","setTimeout","removeClass","hide","init","Y","use","M","course","coursebase","register_module","set_visibility_resource_ui","args","id","mainelement","getDOMNode","cmid","Moodle","core_course","util","cm","getId","Node","get","css","sectionreturn","find","attr","sectionId","closest","activity","addClass","actionarea","add_spinner","show","addActivitySpinner","promises","call","methodname","sectionid","when","apply","done","data","activityHTML","each","elementid","this","replaceWith","invoke_function","core","actionmenu","newDOMNode","one","fail"],"mappings":"AAAAA,2CAAO,CAAC,SAAU,sBAAuB,cAAc,SAASC,EAAGC,OAAQC,UAEnEC,mBACgB,iBADhBA,gBAEa,eAGbC,oBACY,cADZA,oBAEY,WAFZA,mBAGW,sBAgFNC,cAAcC,QAASC,QAASC,OACrCC,OAAOC,YAAW,WACdJ,QAAQK,YAAYR,oBAChBI,SACAA,QAAQK,SAEbJ,aAmCA,CACHK,gBAlHAC,EAAEC,IAAI,4BAA4B,WAE1BC,EAAEC,OAAOC,WAAWC,gBAAgB,CAGhCC,2BAA4B,SAASC,UAoDhCf,QACbgB,GApDgBC,YAAcvB,EAAEqB,KAAKf,QAAQkB,cAC7BC,MAkDHnB,QAlDsBiB,YAoDvCT,EAAEC,IAAI,sBAAsB,SAASD,GACjCQ,GAAKR,EAAEY,OAAOC,YAAYC,KAAKC,GAAGC,MAAMhB,EAAEiB,KAAKzB,QAAQ0B,IAAI,QAExDV,OAtDaG,KAAM,CACNF,YAAYU,IAAI,UAAW,OACvBC,cAAgBX,YAAYY,KAAK,IAAMhC,iBAAiBiC,KAAK,sBAC7DC,UAAYd,YAAYe,QAAQlC,oBAAoBgC,KAAK,WACzD7B,iBA0FAgC,UACxBA,SAASC,SAASrC,wBACdsC,WAAaF,SAASJ,KAAK/B,qBAAqB4B,IAAI,MACpDS,WAAY,KACRlC,QAAUS,EAAEY,KAAKc,YAAY5B,EAAGA,EAAEiB,KAAKU,oBAC3ClC,QAAQoC,OACDpC,eAEJ,KAlG2BqC,CAAmBrB,aAC7BsB,SAAW3C,KAAK4C,KAAK,CAAC,CACtBC,WAAY,6BACZ1B,KAAM,CAACC,GAAIG,KAAMuB,UAAWX,UAAWH,cAAeA,kBACtD,GACJlC,EAAEiD,KAAKC,MAAMlD,EAAG6C,UACXM,MAAK,SAASC,UAmBVC,aAlBLhD,cAAckB,YAAahB,QAAS,KAkB/B8C,aAjBuBD,KAkBpD1C,YAAW,WACPV,EAAE,QAAUqD,aAAe,UAAUlB,KAAK/B,qBAAqBkD,MAAK,eA+CpDC,UA7CRjC,GAAKtB,EAAEwD,MAAMpB,KAAK,MAEtBpC,EAAEI,oBAAsB,IAAMkB,IAAImC,YAAYJ,cA2ClCE,UAzCGjC,GA2CvBR,EAAEC,IAAI,4BAA4B,WAC9BC,EAAEC,OAAOC,WAAWwC,gBAAgB,qBAAsB,IAAMH,cAEhEvC,EAAE2C,KAAKC,YAAc5C,EAAE2C,KAAKC,WAAWC,YACvC7C,EAAE2C,KAAKC,WAAWC,WAAW/C,EAAEgD,IAAI,IAAMP,YA9CrCvD,EAAEI,oBAAsB,IAAMkB,IAAIW,IAAI,UAAW,QAEtD,QA3BwB8B,MAAK,WACJ1D,cAAckB,YAAahB"}